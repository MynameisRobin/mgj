(function(c){var a=am.page.memberDetails=new c.am.Page({id:"page_memberDetails",backButtonOnclick:function(){if(c("#pswp_dom").is(":visible")){am.gallery.close();
}else{c.am.page.back("slidedown");}},init:function(){this.$contentList=this.$.find(".rightBody .commonBox");this.$leftBox=this.$.find(".memberdetailsbox .pageLeft");
this.$tab=this.$.find(".memberDetailsTab");this.$cardBox=this.$.find(".comboBox .leftCard");this.$cardul=this.$cardBox.find("ul");this.$cardLi=this.$cardul.find("li:first");
this.$cardul.empty();this.$comboBox=this.$.find(".comboBox .rightcombo");this.$comboul=this.$comboBox.find(".inner");this.$comboli=this.$comboul.find(".list");
this.$combolii=this.$comboul.find(".list li:first");this.$adbox=this.$.find(".addphoto_model");this.$azbox=this.$.find(".addqzone_model");this.$arbox=this.$.find(".addremark_model");
this.$exbox=this.$.find(".exchange_model");this.$privilegeCardBox=this.$.find(".privilegeCard_model");this.$startInput=this.$.find(".privilegeCard_model .input_start input");
this.$endInput=this.$.find(".privilegeCard_model .input_end input");this.$memberInfo={};this.$comboul.empty();this.$fileBox=this.$.find(".fileBox");this.$fileul=this.$fileBox.find(".inner");
this.$fileli=this.$fileul.find(".listbox:first");this.$imgBoxul=this.$fileli.find("ul");this.$imgBoxli=this.$fileli.find("li:first");this.$fileul.find(".listbox").remove();
this.$imgBoxul.empty();this.fileBoxIndex=0;this.fileBoxSize=10;this.adboxSelectedCategory="";this.adboxSelectedSubCategory="";this.adboxSelectedProductId="";
this.adboxSelectedProductName="";this.adboxSelectedProductTid="";this.recordIndex=1;this.$recordBox=this.$.find(".recordBox .body");this.remarkFlag="";
this.$changeTarget=null;this.$popWrap=this.$.find(".card_popup");this.$cardfeePopup=this.$.find(".popup_right.cardfee");this.$comboPopup=this.$.find(".popup_right.combo");
this.$targetCard=null;this.memberpw="";this.$table=this.$.find(".table-content-list tbody").on("vclick",".signature",function(){var d=c(this);am.signatureView.show({memberId:d.data("memberid"),billId:d.data("billid"),unresign:1,storeId:d.data("storeid"),failed:function(){d.addClass("am-disabled");
}});}).on("vclick",".comment",function(){c(this).parents("tr").next().toggle();a.tableScroll.refresh();});this.phtotypeScroll=new c.am.ScrollView({$wrap:a.$adbox.find(".mbody-left .photo_typebox"),$inner:a.$adbox.find(".mbody-left .photo_typebox>ul"),direction:[false,true],hasInput:false});
this.listDialogScroll=new c.am.ScrollView({$wrap:a.$adbox.find(".pro_list_dialog .pro_list_scroll"),$inner:a.$adbox.find(".pro_list_dialog .pro_list_scroll>ul"),direction:[false,true],hasInput:false});
c.each(metaConfig.invention.subCategories,function(e,f){var d='<li class="am-clickable" pid="'+f.category+'" tid="'+f.subCategory+'">'+f.subCategoryName+"</li>";
a.$adbox.find(".mbody-left .photo_typebox>ul").append(d);});this.$.find(".footbtn").vclick(function(){if(am.operateArr.indexOf("R")!=-1){c.am.changePage(am.page.addMember,"slideup",{userInfo:a.$userInfo});
}else{am.msg("你没有权限进行此操作");}});this.$.find(".remarks").on("vclick",".more",function(){var d=c(this);var f=d.parent(".remarks");var g=f.text().replace(/更多|收起|修改/g,"");
var e=f.data("remarks");if(d.hasClass("on")){f.html(e+'<a href="javascript:;" class="more am-clickable">更多</a><a href="javascript:;" class="edit am-clickable">修改</a>');
f.data("remarks",g);}else{f.html(e+'<a href="javascript:;" class="more am-clickable on">收起</a><a href="javascript:;" class="edit am-clickable">修改</a>');
f.data("remarks",g);}});this.$.find(".remarks").on("vclick",".edit",function(){if(!a.remarksPermissions()){return;}var f=c(this);var d=f.siblings(".more");
var g=f.parent(".remarks");if(d.hasClass("on")){var e=g.text().replace(/更多|收起|修改/g,"");}else{var e=g.data("remarks");}var h='<textarea maxlength="100">'+e+"</textarea>";
setTimeout(function(){g.css({"min-height":"48px"});g.parent(".remarkswrap").append(h);a.$.find(".remarkswrap textarea").focus();},250);});this.$.find(".remarkswrap").on("blur","textarea",function(){a.$.find(".remarks").css({"min-height":"auto"});
var g=c(this);var e=a.$leftBox.data("item").id;var f=c(this).val();var d={memId:e,page:f};am.loading.show("修改中,请稍候...");am.api.memberUpdatepage.exec(d,function(h){am.loading.hide();
console.log(h);if(h.code==0){g.remove();a.$userInfo.page=d.page;if(a.getLength(d.page)>88){a.$.find(".remarks").data("remarks",d.page).html(a.mySubStr(d.page,88)+'...<a href="javascript:;" class="more am-clickable">更多</a><a href="javascript:;" class="edit am-clickable">修改</a>');
}else{if(d.page==""){a.$.find(".remarks").html("");}else{a.$.find(".remarks").data("remarks",d.page).html(d.page+'<a href="javascript:;" class="edit am-clickable">修改</a>');
}}}else{am.msg(h.message||"数据获取失败,请检查网络!");}});});this.$fileBox.on("vclick",".leftTit span.lookmsg,.leftTit span.lookphoto",function(){c(this).addClass("selected").siblings().removeClass("selected");
a.renderOurselves(true);}).on("vclick",".leftTit span.addphoto",function(){a.$adbox.addClass("hide");a.$azbox.addClass("hide");if(a.$fileBox.find(".leftTit span.addphoto").text()=="添加照片"){a.$adbox.removeClass("hide");
a.phtotypeScroll.refresh();}else{a.$azbox.removeClass("hide");setTimeout(function(){a.$azbox.find('textarea[name="addqzone_qzone_content"]').focus();},100);
}}).on("vclick",".imglist ul>li",function(){var e=[];var d=c(this).index();c(this).parent().find("img").each(function(){e.push({src:c(this).attr("src").replace("_s","_l"),w:1024,h:1024});
});a.pswpTimer&&clearTimeout(a.pswpTimer);am.loading.show();a.pswpTimer=setTimeout(function(){am.loading.hide();am.pswp(e,d);},800);});a.$arbox.on("vclick",".addremark_model_mask,.addremark_model-header .right_btn,.addremark_model-footer .cancel_btn",function(){a.$arbox.addClass("hide");
a.$.find("[isdisabled=1]").addClass("am-clickable");}).on("vclick",".save_btn",function(){var e=a.$arbox.find("textarea[name='addremark_qzone_content']").val();
var f=a.$arbox.data("id");console.log(f);if(e.length<0||e.length>20){amGloble.msg("请输入0-20个字符备注内容！");return;}amGloble.loading.show();var d={};if(a.remarkFlag=="card"){d={cardRemark:e,cardId:f};
}else{if(a.remarkFlag=="combo"){d={id:f,itemRemark:e};}}a.submitRemark(d,a.remarkFlag);});a.$azbox.on("vclick",".addqzone_model_mask,.addqzone_model-header .right_btn,.addqzone_model-footer .cancel_btn",function(){a.$azbox.addClass("hide");
}).on("vclick",".save_btn",function(){var f=a.$azbox.find("textarea[name='addqzone_qzone_content']").val();if(f.length<1||f.length>200){amGloble.msg("请输入1-200个字符客户档案内容！");
return;}amGloble.loading.show();var d=amGloble.metadata.userInfo;var e={memId:a.$userInfo.id,shopId:amGloble.metadata.userInfo.shopId,userType:d.userType,userId:d.userId,userName:d.userName,archives:f};
a.submitArchives(e);});a.$adbox.on("vclick",".addphoto_model_mask,.addphoto_model-header .right_btn,.addphoto_model-footer .cancel_btn",function(){a.$adbox.addClass("hide");
}).on("vclick",".mbody-left .photo_typebox>ul>li",function(){var f=this;var e=[];a.$adbox.find(".photo_upload_boxs li").each(function(){var g=c(this).data("id");
if(g){e.push(g);}});function d(){a.adboxSelectedCategory=c(f).attr("pid");a.adboxSelectedSubCategory=c(f).attr("tid");a.$adbox.find(".mbody-left .left-dot").addClass("selected");
a.$adbox.find(".mbody-left .photo_typebox>ul>li").removeClass("selected");c(f).addClass("selected");}if(e.length){amGloble.confirm("需要重新上传照片","修改作品类别后需要重新上传照片，确定要这样做吗？","确定","返回",function(){a.$adbox.find(".photo_upload_boxs ul").html('<li class="empty_box am-clickable"></li>');
d();},function(){});}else{d();}}).on("change",".mui-switch",function(){if(c(this).prop("checked")){a.$adbox.find(".mbody-right .right_mid").addClass("selected");
}else{a.$adbox.find(".mbody-right .right_mid").removeClass("selected");}}).on("keyup",".text_content textarea",function(){if(c(this).val().length>0){a.$adbox.find(".mbody-right .right_bottom").addClass("selected");
}else{a.$adbox.find(".mbody-right .right_bottom").removeClass("selected");}}).on("click","*",function(){if(c){if(c(this).hasClass("nothide")){event.stopPropagation();
return false;}a.$adbox.find(".pro_list_dialog").hide();a.$adbox.find(".pro_list_dialog").removeClass("right");}}).on("vclick",".linked_btn",function(){if(!a.$adbox.find(".pro_list_dialog").is(":visible")){a.$adbox.find(".pro_list_dialog").show();
a.listDialogScroll.refresh();}else{a.$adbox.find(".pro_list_dialog").hide();}}).on("vclick",".relink_btn",function(){if(!a.$adbox.find(".pro_list_dialog").is(":visible")){a.$adbox.find(".pro_list_dialog").show();
a.$adbox.find(".pro_list_dialog").addClass("right");a.listDialogScroll.refresh();}else{a.$adbox.find(".pro_list_dialog").removeClass("right");a.$adbox.find(".pro_list_dialog").hide();
}a.$adbox.find("input[name='workPrice']").val(c(this).find("span").last().text().replace("￥",""));a.$adbox.find("input[name='workPrice']").attr("readonly","readonly");
}).on("vclick",".pro_list_dialog li",function(){a.adboxSelectedProductId=c(this).attr("iid");a.adboxSelectedProductName=c(this).find("span").first().text();
a.adboxSelectedProductTid=c(this).attr("tid");a.$adbox.find(".pro_list_dialog").hide();a.$adbox.find(".link_box").addClass("hide");a.$adbox.find(".linked_box").removeClass("hide");
a.$adbox.find(".pro_list_dialog").removeClass("right");a.$adbox.find(".item_name").text(c(this).find("span").first().text());a.$adbox.find(".item_price").text(c(this).find("span").last().text());
a.$adbox.find(".right_top").addClass("selected");a.$adbox.find("input[name='workPrice']").val(c(this).find("span").last().text().replace("￥",""));a.$adbox.find("input[name='workPrice']").attr("readonly","readonly");
}).on("vclick",".cancel_link_btn",function(){a.adboxSelectedProductId="";a.adboxSelectedProductName="";a.adboxSelectedProductTid="";a.$adbox.find(".linked_box").addClass("hide");
a.$adbox.find(".link_box").removeClass("hide");a.$adbox.find(".right_top").removeClass("selected");a.$adbox.find("input[name='workPrice']").val("");a.$adbox.find("input[name='workPrice']").removeAttr("readonly");
}).on("vclick",".save_btn",function(){var h=[];a.$adbox.find(".photo_upload_boxs li").each(function(){var i=c(this).data("id");if(i){h.push(i);}});if(h.length<1){amGloble.msg("请至少上传一张图片！");
return;}var g=a.$adbox.find("textarea[name='talk_content']").val();if(g.length<1||g.length>200){amGloble.msg("请输入1-200字符的描述内容！");return;}var f=a.adboxSelectedSubCategory;
if(!f){amGloble.msg("请选择作品类别！");return;}var e=a.$adbox.find("input[name='workPrice']").val();if(e&&(e*1<0||e*1>50000||!e*1)){amGloble.msg("请输入门店原价,0-50000！");
return;}var d={parentShopId:amGloble.metadata.userInfo.parentShopId,title:g,photo:h.join(","),operatorId:amGloble.metadata.userInfo.userId,empId:amGloble.metadata.userInfo.userId,empName:amGloble.metadata.userInfo.userName,empLevelName:amGloble.metadata.userInfo.levelName||"",type:a.adboxSelectedCategory*1,subType:f,price:e*1,empType:amGloble.metadata.userInfo.userType};
if(a.$adbox.find("input[name='showInMYKSwitch']").prop("checked")){d.visible=1;}else{d.visible=0;}d.shopId=amGloble.metadata.userInfo.shopId;d.memId=a.$userInfo.id;
d.memName=a.$userInfo.name;if(a.adboxSelectedProductId!=""){d.itemId=a.adboxSelectedProductId;d.itemName=a.adboxSelectedProductName;d.itemType=a.adboxSelectedProductTid;
}a.submitCraft(d);}).on("vclick",".photo_upload_boxs li",function(){var f=c(this);var d=amGloble.metadata.userInfo;if(a.adboxSelectedCategory==""){amGloble.msg("请选定作品类别后上传照片！");
return;}var e={parentShopId:d.parentShopId,catigoryId:a.adboxSelectedCategory*1,authorId:d.userId};amGloble.photoManager.takePhoto("show",e,function(g){f.html(amGloble.photoManager.createImage("show",e,g,"s"));
f.data("id",g);if(f.hasClass("empty_box")){f.removeClass("empty_box");if(a.$adbox.find(".photo_upload_boxs li").length<9){a.$adbox.find(".photo_upload_boxs ul").append('<li class="empty_box am-clickable"></li>');
}}else{}},function(){console.log("fail");});});this.$.find(".memberDetailsTab").on("vclick","li",function(){var e=c(this);var d=e.index();a.changeTab(d);
a.cardScroll.scrollTo("top");a.cardScroll.refresh();a.comboScroll.scrollTo("top");a.comboScroll.refresh();a.select.hide(true);});this.$.on("vclick",".recordBox .header .btn",function(){a.select.hide(true);
}).on("vclick",".comboBox .leftCard .cardBox li",function(){var f=c(this).data("item");if(c(this).hasClass("addcard")){c.am.changePage(am.page.memberCard,"slideup",{reset:am.convertMemberDetailToSearch({memberInfo:a.$userInfo,card:a.cardCash[0]})});
return;}if(f.invaliddate){var e=new Date(f.invaliddate*1||f.invaliddate);var g=new Date();e.setDate(e.getDate()+1);if(e){if(g.getTime()<=e.getTime()){}else{var d=am.metadata.cardTypeMap[f.cardtypeid];
if(d&&d.expiredpayflag&&d.expiredpayflag=="0"&&am.operateArr.indexOf("U")==-1){am.confirm("已过期","此会员卡已过期，无法继续使用","知道了","返回");return;}else{am.msg("此会员卡已过期！");
}}}}if(!f.allowkd&&f.shopId!=am.metadata.userInfo.shopId){am.msg("此会员卡不允许跨店消费！");return;}if(a.selectCardId){c(this).addClass("selected").siblings().removeClass("selected");
console.log(f);c.am.changePage(c.am.history[c.am.history.length-1],"slideup",{cardData:{memberInfo:a.$userInfo,card:f}});}else{amGloble.confirm("使用此会员卡","去项目卖品收银？","去收银","返回",function(){c.am.changePage(am.page.service,"slideup",{reset:am.convertMemberDetailToSearch({memberInfo:a.$userInfo,card:f})});
},function(){});}}).on("vclick",".cardBox .free .otherAction",function(m){m.stopPropagation();var g="请选择相应的操作",q=[{name:"充值"},{name:"设置密码"},{name:"清除密码"},{name:"修改卡余额"},{name:"修改卡赠送金"}],l=[],k=this;
var j=c(this).parents("li").data("item");console.log(j);var p=0;if(j.invaliddate){var o=new Date(j.invaliddate*1||j.invaliddate);var f=new Date();if(o){if(f.getTime()>o.getTime()){p=1;
}}}if(!p&&j.cardtype==1&&(j.timeflag==0||j.timeflag==2)){l.push({name:"充值"});}var d={};for(var h=0;h<am.metadata.cardTypeList.length;h++){if(am.metadata.cardTypeList[h].cardtypeid==j.cardtypeid){d=am.metadata.cardTypeList[h];
}}var r=am.convertMemberDetailToSearch({memberInfo:a.$userInfo,card:j}).shopId;if(j.cardtype==2&&j.invaliddate&&d&&d.mgjCardRenewal&&JSON.parse(d.mgjCardRenewal).length&&am.checkCrossConsum(r)){l.push({name:"续卡"});
}if(!a.memberpw){l.push({name:"设置密码"});}else{if(am.operateArr.indexOf("X1")>-1){l.push({name:"设置密码"});}}if(am.operateArr.indexOf("X2")>-1&&a.memberpw){l.push({name:"清除密码"});
}if((j.timeflag=="0"&&j.cardtype!="2")&&am.operateArr.indexOf("A")>-1){l.push({name:"修改卡余额"},{name:"修改卡赠送金"});}if(j.timeflag!="1"&&j.cardtype!="2"&&am.operateArr.indexOf("K")>-1){l.push({name:"卡金转出"});
l.push({name:"卡金转入"});}if(am.operateArr.indexOf("E")>-1){l.push({name:"删除卡"});}am.popupMenu(g,l,function(t){console.log(t);if(t&&t.name=="充值"){var w=am.metadata.cardTypeList.filter(function(z){return z.cardtypeid==j.cardtypeid;
});if(w&&w[0]&&w[0].mgj_stopNoRecharge&&w[0].newflag=="0"){amGloble.msg("【"+w[0].cardtypename+"】已停止办理，无法继续充值！");return;}var n=am.convertMemberDetailToSearch({memberInfo:a.$userInfo,card:j});
am.pw.check(n,function(z){if(z){console.log(j);c.am.changePage(am.page.pay,"slideup",{action:"recharge",member:n});}});}else{if(t&&t.name=="卡金转出"){var s=c(k).parents("li");
a.cardPopup.show(j,s);}else{if(t&&t.name=="卡金转入"){var s=c(k).parents("li",2);a.cardPopup.show(j,s,1);}else{if(t&&t.name=="设置密码"){var s=c(k).parents("li");
var v=s.data("item");console.log(v);am.keyboard.show({title:"请输入密码",hidedot:true,submit:function(A){if(A.length>6){am.msg("您输入的6位以内数字密码!");return true;
}else{if(A==""){am.msg("请输入密码!");return true;}}console.log(j);var z={passwd:A,memId:j.memberid,mobile:j.mobile,name:j.name};am.loading.show("设置密码中,请稍候...");
am.api.setCardpw.exec(z,function(B){am.loading.hide();console.log(B);if(B.code==0){v.passwd=z.passwd;s.data("item",v);console.log(a.$userInfo);a.$userInfo.passwd=z.passwd;
am.msg("密码设置成功");}else{am.msg(B.message||"数据获取失败,请检查网络!");}});}});}else{if(t&&t.name=="清除密码"){var s=c(k).parents("li");var v=s.data("item");console.log(v);
var i={passwd:null,memId:j.memberid,mobile:j.mobile,name:j.name};am.loading.show("清除密码中,请稍候...");am.api.setCardpw.exec(i,function(z){am.loading.hide();
console.log(z);if(z.code==0){v.passwd=i.passwd;s.data("item",v);a.$userInfo.passwd=i.passwd;am.msg("密码清除成功");}else{am.msg(z.message||"数据获取失败,请检查网络!");}});
}else{if(t&&t.name=="修改卡余额"){var s=c(k).parents("li");var v=s.data("item");console.log(v);var x=v.id;var u=v.sumcardfee;am.keyboard.show({title:"请输入金额",submit:function(A){if(A-99999999>0){am.msg("您输入的金额不能大于99999999!");
return true;}else{if(A==""){am.msg("请输入修改金额!");return true;}}var z={id:x,shopId:v.shopid||amGloble.metadata.userInfo.shopId,cardfee:A,sumcardfee:u,cardNo:v.cardid,operator:amGloble.metadata.userInfo.userName,oldCardfee:v.cardfee,oldPresentfee:v.presentfee,oldSumcardfee:v.sumcardfee,oldSumpresentfee:v.sumpresentfee};
if((A-0)>(u-0)){z.sumcardfee=A;}am.loading.show("修改中,请稍候...");am.api.memberModiFee.exec(z,function(B){am.loading.hide();console.log(B);if(B.code==0){s.find(".card_fee .fee_num").html("￥"+z.cardfee);
v.cardfee=z.cardfee;v.sumcardfee=z.sumcardfee;c.each(a.cardCash,function(D,C){if(x==C.id){C.cardfee=z.cardfee;C.sumcardfee=z.sumcardfee;}});s.data("item",v);
}else{am.msg(B.message||"数据获取失败,请检查网络!");}});}});}else{if(t&&t.name=="修改卡赠送金"){var s=c(k).parents("li");var v=s.data("item");console.log(v);var x=v.id;
var y=v.sumpresentfee;am.keyboard.show({title:"请输入金额",submit:function(A){if(A-99999999>0){am.msg("您输入的金额不能大于99999999!");return true;}else{if(A==""){am.msg("请输入修改金额!");
return true;}}var z={id:x,shopId:amGloble.metadata.userInfo.shopId+"",presentfee:A,sumpresentfee:y==null?"0":y,cardNo:v.cardid,operator:amGloble.metadata.userInfo.userName,oldCardfee:v.cardfee,oldPresentfee:v.presentfee,oldSumcardfee:v.sumcardfee,oldSumpresentfee:v.sumpresentfee==null?"0":v.sumpresentfee};
if((A-0)>(y-0)){z.sumpresentfee=A;}am.loading.show("修改中,请稍候...");am.api.memberModiFee.exec(z,function(B){am.loading.hide();console.log(B);if(B.code==0){s.find(".card_present .fee_num").html("￥"+z.presentfee);
v.presentfee=z.presentfee;v.sumpresentfee=z.sumpresentfee;c.each(a.cardCash,function(D,C){if(x==C.id){C.presentfee=z.presentfee;C.sumpresentfee=z.sumpresentfee;
}});s.data("item",v);}else{am.msg(B.message||"数据获取失败,请检查网络!");}});}});}else{if(t&&t.name=="删除卡"){var e=j.id;console.log(e);a.cardDel(e);}else{if(t&&t.name=="续卡"){var n=am.convertMemberDetailToSearch({memberInfo:a.$userInfo,card:j});
am.pw.check(n,function(z){if(z){console.log(j);c.am.changePage(am.page.pay,"slideup",{action:"recharge",member:n,card:j,renewal:1});}});}}}}}}}}}});}).on("vclick",".cardBox .duedatewrap .duedateedit",function(f){f.stopPropagation();
var d=c(this).parents("li").data("item");console.log(d);}).on("vclick",".cardBox .free .remarkIcon",function(f){a.$.find("[isdisabled=1]").removeClass("am-clickable");
f.stopPropagation();var d=c(this).parents("li").data("item");a.$changeTarget=c(this).parents("li");console.log(d);a.$arbox.find("textarea").val(d.cardRemark).end().removeClass("hide").data("id",d.id);
a.remarkFlag="card";return false;}).on("vclick",".comboBox .comboRemarkIcon",function(f){a.$.find("[isdisabled=1]").removeClass("am-clickable");f.stopPropagation();
var d=c(this).parents("li").data("item");a.$changeTarget=c(this).parents("li");console.log(d);a.$arbox.find("textarea").val(d.itemRemark).end().removeClass("hide").data("id",d.id);
a.remarkFlag="combo";}).on("vclick",".rightcombo .list ul li .treatmentdateedit",function(f){f.stopPropagation();var d=c(this).parents("li").data("item");
console.log(d);}).on("vclick",".rightcombo .list ul li .back_combo",function(g){g.stopPropagation();var d=c(this).parents("li");var f=c(this).parents("li").data("item");
a.comboPopup.show(f,d);}).on("vclick",".filebody .cm_cutting .btn",function(){a.renderOurselves(true);}).on("vclick",".recordBox .cm_cutting .btn",function(){a.renderRecord(true);
});this.fileScroll=new c.am.ScrollView({$wrap:this.$.find(".filebody"),$inner:this.$.find(".filebody .inner"),direction:[false,true],hasInput:false,touchTopcallback:function(){a.renderOurselves(true);
},touchBottomcallback:function(){a.renderOurselves();},pauseTouchTop:false,pauseTouchBottom:false});am.extendScrollView(this.fileScroll);this.cardScroll=new c.am.ScrollView({$wrap:this.$.find(".comboBox .cardBox"),$inner:this.$.find(".comboBox .cardBox .inner"),direction:[false,true],hasInput:false});
this.cardScroll.refresh();this.comboScroll=new c.am.ScrollView({$wrap:this.$.find(".comboBox .combobox"),$inner:this.$.find(".comboBox .combobox .inner"),direction:[false,true],hasInput:false});
this.comboScroll.refresh();this.$list=this.$.find(".comboBox .list");this.select=new c.am.Select({$:a.$.find(".recordBox .selectList"),data:[{name:"原项目消费历史纪录",value:1},{name:"原商品购买记录",value:1},{name:"原套餐购买记录",value:1}]});
this.privilegeCardSelect=new c.am.Select({$:a.$.find(".privilegeCardSelect"),data:[{name:"一个月",value:1},{name:"三个月",value:3},{name:"半年",value:6},{name:"一年",value:12},{name:"不限期",value:-1},{name:"自定义有效期",value:0},],onSelect:function(){if(!a.privilegeCardSelect.getValue()){a.$privilegeCardBox.find(".validDate .item_input").removeClass("hide");
}else{if(!a.$privilegeCardBox.find(".validDate .item_input").hasClass("hide")){a.$privilegeCardBox.find(".validDate .item_input").addClass("hide");}}}});
this.tableScroll=new c.am.ScrollView({$wrap:this.$.find(".table-content-list"),$inner:this.$.find(".table-content-list table"),direction:[false,true],hasInput:false});
this.tableScroll.refresh();this.pager=new c.am.Paging({$:a.$.find(".footcontent"),showNum:15,total:1,action:function(e,d){a.recordIndex=d+1;a.renderRecord();
}});this.renderList=["renderOurselves","renderCard","renderRecord"];this.$leftBox.on("vclick",".exchange",function(){if(c(this).data("point")==0){am.msg("您暂时没有可兑换的门店消费积分！");
return;}a.$.find(".total strong").text(c(this).data("point"));a.$exbox.removeClass("hide").end().find(".exinner").empty();a.renderCredit();a.exboxScroll.refresh();
});a.$exbox.on("vclick",".exchange_model_mask,.exheadright",function(){a.$exbox.addClass("hide");}).on("vclick",".changebox",function(){c(this).addClass("selected").siblings().removeClass("selected");
}).on("vclick",".save_exchange",function(){a.exchangePoint();});this.$leftBox.on("vclick",".privilegeCardBtn",function(){if(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("ownerId")&&a.$memberInfo.id==a.$memberInfo.privilege.ownerId){a.$privilegeCardBox.find(".headleft").text("为此顾客延期商城特权");
a.$privilegeCardBox.find(".save_privilegeCard").text("延期特权");}a.$privilegeCardBox.removeClass("hide");});a.$privilegeCardBox.on("vclick",".privilegeCard_model_mask,.headright",function(){a.$privilegeCardBox.addClass("hide");
}).on("vclick",".save_privilegeCard",function(){a.eidtPrivilegeTime();});this.cardPopup=new b({$:c(".cardfee_popup"),type:1,onRender:function(d,e){if(e){d.find(".card_no .line_val").text(e.cardid+" ("+e.cardtypename+")").end().find(".card_shop .line_val").text((a.getshopName(e.shopid).replace(/\s/g,"")||"门店名称未设定")).end().find(".card_fee .line_val").text("￥"+am.cashierRound(e.cardfee)).end().find(".card_pfee .line_val").text("￥"+am.cashierRound(e.presentfee));
}else{d.find(".card_no .line_val").text("").end().find(".card_shop .line_val").text("").end().find(".card_fee .line_val").text("").end().find(".card_pfee .line_val").text("");
}},onSubmit:function(e,d,f){am.loading.show("正在转账，请稍候...");am.api.transferMemberCard.exec({parentShopId:am.metadata.userInfo.parentShopId,shopId:am.metadata.userInfo.shopId,outCardId:e.outCardId,inCardId:e.inCardId,cardFee:(e.cardFee||0),presentFee:(e.presentFee||0),},function(g){am.loading.hide();
if(g.code==0){am.msg("卡金转出成功！");d&&d();}else{am.msg(g.message||"转账失败，请重试！");f&&f();}});},onCheck:function(d,j,i){if(!j||!i){am.msg("请先选择好一张"+(this.isExchange?"转出":"转入")+"卡！");
return false;}var g=am.cashierRound(i.cardfee);var k=am.cashierRound(i.presentfee);var f=Number(d.find(".trans_fee input").val());var e=Number(d.find(".trans_pfee input").val());
if(i.id==j.id){am.msg("转入卡和转出卡是同一张不能转账！");return false;}if(j.cardtype==2||j.timeflag==1){am.msg("资格卡和计次卡不能转卡金！");return false;}else{if((!f)&&(!e)){am.msg("请至少填写一个金额！");
return false;}if(f&&f>g){am.msg("转出卡卡金余额不够！");return false;}if(e&&e>k){am.msg("转出卡赠送金余额不够！");return false;}var h={outCardId:i.id,inCardId:j.id,};f&&(h.cardFee=f);
e&&(h.presentFee=e);console.log(h);return h;}},onChangeMemory:function(o,e,k,l){if(k.id==e.id){return;}else{var d=l.cardFee;var f=l.presentFee;var m=k.cardfee*1-(d||0);
var g=k.presentfee*1-(f||0);k.cardfee=m;k.presentfee=g;var j=-1;c.each(a.cardCash,function(q,p){if(k.id==p.id){p.cardfee=m;p.presentfee=g;j=q;}});if(j>=0){a.$cardul.find("li").eq(j).data("item",k).find(".card_fee .fee_num").html("￥"+m).end().find(".card_present .fee_num").html("￥"+g);
}var n=e.cardfee*1+(d||0);var h=e.presentfee*1+(f||0);var i=-1;c.each(a.cardCash,function(q,p){if(e.id==p.id){p.cardfee=n;p.presentfee=h;p.sumcardfee=p.sumcardfee+(d||0);
p.sumpresentfee=p.sumcardfee+(f||0);i=q;}});if(i>=0){a.$cardul.find("li").eq(i).find(".card_fee .fee_num").html("￥"+n).end().find(".card_present .fee_num").html("￥"+h);
}}},});this.comboPopup=new b({$:c(".combo_popup"),type:2,ownCards:a.cardCash,onRender:function(d,h){if(h){var g=h.cardFee;var i=h.cashFee;var f=h.otherFee;
var e=h.leavemoney;console.log(h);d.find(".combo_name").text((h.itemname||" ")).end().find(".combo_times .line_val").text(((h.sumtimes==0||h.sumtimes==-99)?"不限":h.sumtimes)+"次").end().find(".combo_remain .line_val").text(((h.leavetimes==0||h.leavetimes==-99)?"不限":h.leavetimes)+"次").end().find(".combo_total .line_val").text("￥"+am.cashierRound(h.summoney)).end().find(".combo_once .line_val").text("￥"+am.cashierRound(h.oncemoney)).end().find(".combo_money .line_val").text("￥"+am.cashierRound(h.oncemoney)).end().find(".combo_btime .line_val").text(h.buyDate?new Date(h.buyDate).format("yyyy.mm.dd"):"");
}else{d.find(".combo_name").text(" ").end().find(".combo_times .line_val").text("").end().find(".combo_remain .line_val").text("").end().find(".combo_total .line_val").text("").end().find(".combo_once .line_val").text("").end().find(".combo_btime .line_val").text("");
}},onSubmit:function(e,d,f){am.loading.show("正在退款，请稍候...");am.api.backCombo.exec({parentShopId:am.metadata.userInfo.parentShopId,shopId:am.metadata.userInfo.shopId,outCardId:e.outCardId,outMemberId:e.outMemberId,inCardId:e.inCardId,treatItemId:e.treatItemId,treatMoney:e.treatMoney||0,treatNum:e.treatNum,},function(g){am.loading.hide();
if(g.code==0){am.msg("套餐退款成功！");d&&d();}else{am.msg(g.message||"退款失败，请重试！");f&&f();}});},onCheck:function(p,g,l){var j=am.cashierRound(l.leavetimes);var h=am.cashierRound(l.sumtimes);
var k=am.cashierRound(l.leavemoney);var f=am.cashierRound(l.oncemoney);var i=Number(p.find(".trans_fee input").val());var o=Number(p.find(".trans_pfee input").val());
var m=true;if((h==0||h==-99)||(j==0||j==-99)){m=false;}if(g){if(g.cardtype==2||g.timeflag=="1"){am.msg("资格卡计次卡不能用来退套餐！");return false;}else{if(!m){am.msg("不限次的套餐，只需要输入退款金额！");
i=j;}else{if(!i){am.msg("请输入退套餐的次数！");return false;}if(i&&i>j){am.msg("您输入退套餐的次数大于剩余次数！");return false;}else{if(!/^\d+$/.test(i)){am.msg("您输入退套餐的次数应该为正整数！");
return false;}}if(f){if(o>(f*i)){am.msg("限次的套餐，退款金额不能大于次数乘以单价！");return false;}}}var e={outCardId:l.memcardid,outMemberId:l.memberid,inCardId:g.id,treatItemId:l.id,};
var n=i*1;var d=o*1;if(isNaN(n)||isNaN(d)){am.msg("您的输入有误！");return false;}e.treatNum=n;e.treatMoney=d;console.log(e);return e;}}else{am.msg("请先选择好一张退入卡！");
return false;}},onChangeMemory:function(l,f,j,k){console.log(l,j,k);var e=a.$userInfo.treatMentItems;if((j.sumtimes==0||j.sumtimes==-99)||(j.leavetimes==0||j.leavetimes==-99)){l.remove();
var h=-1;c.each(e,function(m,n){if(n.memcardid==j.memcardid){h=m;}});h>=0&&e.splice(h,1);}else{var h=-1;c.each(e,function(m,n){if(n.memcardid==j.memcardid&&j.id==n.id){if(n.leavetimes>=1){n.leavetimes=am.cashierRound(n.leavetimes-k.treatNum);
n.leavemoney=am.cashierRound(n.leavemoney-k.treatMoney);if(n.leavetimes<=0){h=m;}}}});h>=0&&e.splice(h,1);h>=0&&l.remove();console.log(e);a.renderCircle(e,true);
}a.comboScroll.refresh();var i=k.treatMoney||0;if(f.memberid==j.memberid&&i){var d=0,g=0;c.each(a.cardCash,function(n,m){if(f.id==m.id){d=Number(m.cardfee)+(i||0);
g=Number(m.sumcardfee)+(i||0);m.cardfee=d;m.sumcardfee=g;h=n;}});a.$cardul.find("li").eq(h).find(".card_fee .fee_num").html("￥"+d);}},});this.exboxScroll=new c.am.ScrollView({$wrap:this.$.find(".goodlist"),$inner:this.$.find(".goodlist .exinner"),direction:[false,true],hasInput:false});
this.exboxScroll.refresh();},remarksPermissions:function(){if(amGloble.metadata.userInfo.operatestr.indexOf("Y,")==-1){am.msg("您没有权限修改会员备注!");return false;
}return true;},modifyBalancePermissions:function(){if(amGloble.metadata.userInfo.operatestr.indexOf("A,")==-1){am.msg("您没有权限修改会员充值卡充值总额及余额!");return false;
}return true;},beforeShow:function(d){if(d=="back"){return;}console.log("am.metadata给大爷笑个,chali",am.metadata);if(!d){return;}this.comboScroll.refresh();
this.$.find(".remarks").html("");this.$data=d;if(d.hasOwnProperty("cardId")){this.selectCardId=d.cardId;}else{this.selectCardId=null;}a.getData(function(g){a.renderUserInfo(g);
if(d.hasOwnProperty("tabId")){a.changeTab(d.tabId);}var h=(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("createTime"))?new Date(a.$memberInfo.privilege.createTime):amGloble.now();
var f=(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("expireDate")&&a.$memberInfo.privilege.expireDate!=null)?new Date(a.$memberInfo.privilege.expireDate):amGloble.now();
var e=new Date(h.getFullYear()+10,h.getMonth(),h.getDate());a.$startInput.val(h.format("yyyy-mm-dd"));a.$endInput.val(f.format("yyyy-mm-dd"));a.updateData();
a.calendarInstanceEnd=a.$endInput.mobiscroll().calendar({theme:"mobiscroll",lang:"zh",display:"bottom",months:"auto",min:h,max:e,setOnDayTap:true,buttons:[],onSet:function(i,j){a.$endInput.val(new Date(i.valueText).format("yyyy-mm-dd"));
}});});this.getMallItemData(function(e){a.$adbox.find(".pro_list_scroll ul").html("");c.each(e,function(g,h){var f='<li class="nothide am-clickable" tid="'+h.category+'" iid="'+h.id+'" ><span class="nothide">'+h.name+'</span><span class="nothide">￥'+h.price+"</span></li>";
a.$adbox.find(".pro_list_scroll ul").append(f);});});},afterShow:function(d){this.tableScroll.refresh();this.comboScroll.refresh();},beforeHide:function(d){this.selectCardId=null;
c("#pswp_dom").removeClass("pswp--open");},updateData:function(d){if(am.metadata.configs.hasOwnProperty("mgjMallPrivilege")?am.metadata.configs.mgjMallPrivilege:false){a.$.find(".privilegeCardButton").removeClass("hide");
if(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("ownerId")&&a.$memberInfo.id==a.$memberInfo.privilege.ownerId){a.$.find(".privilegeCardBtn").removeClass("bgColor");
a.$.find(".privilegeCardBtn .crown").removeClass("crown").addClass("ico");a.$.find(".privilegeCardBtn .value").text("已开通商城特权");a.$.find(".privilegeCardBtn .tips").removeClass("hide");
var e="有效期至:"+(a.$memberInfo.privilege.expireDate!=null?new Date(a.$memberInfo.privilege.expireDate).format("yyyy-mm-dd"):"不限期");a.$.find(".privilegeCardBtn .tips").text(e);
}else{if(!a.$.find(".privilegeCardBtn .tips").hasClass("hide")){a.$.find(".privilegeCardBtn .tips").addClass("hide");a.$.find(".privilegeCardBtn").addClass("bgColor");
a.$.find(".privilegeCardBtn .crown").addClass("crown");a.$.find(".privilegeCardBtn .value").text("开通商城特权");}}this.privilegeCardSelect.setValue(0);}},cardDel:function(e){var d=a.cardCash.length;
if(d==1){am.msg("请至少要保留一张卡！");return;}atMobile.nativeUIWidget.confirm({caption:"删除卡",description:"卡片删除后仅可在后台恢复，确认删除么？",okCaption:"删除",cancelCaption:"取消"},function(){am.loading.show("正在删除，请稍候...");
am.api.delCard.exec({parentShopId:am.metadata.userInfo.parentShopId,shopId:am.metadata.userInfo.shopId,id:e},function(f){am.loading.hide();if(f.code==0){am.msg("成功删除！");
a.cardDelMemoryChange(e);}else{am.msg(f.message||"删除失败，请重试！");}});},function(){});},cardDelMemoryChange:function(f){var d=-1;c.each(a.cardCash,function(h,g){if(f==g.id){d=h;
}});a.cardCash.splice(d,1);this.$cardul.find("li").eq(d).remove();var e=this.$comboBox.find(".list");e.each(function(g,h){var j=c(h).data("cardid");if(j==f){c(h).remove();
}});this.cardScroll.refresh();this.comboScroll.refresh();},selecteCombo:function(n){this.$comboul.find("li").removeClass("selected");if(!n||n.length==0){return;
}var m=[],k=[];var f=this.$comboul.data("item");for(var h=0;h<n.length;h++){m.push(n[h].id);}if(!f||f.length==0){return;}for(var e=0;e<f.length;e++){var g=c.inArray(f[e].id,m);
if(g>=0){k.push(e);}}if(!k||k.length==0){return;}for(var d=0;d<k.length;d++){this.$comboul.find("li").eq(k[d]).addClass("selected");}},changeTab:function(d){var e=this.$contentList.hide();
var f=this.$tab.find("li").removeClass("selected");e.eq(d).show();f.eq(d).addClass("selected");this[this.renderList[d]](true);},renderCircle:function(l,e){var h=this.$comboul.find("canvas");
var g=[];for(var f=0;f<l.length;f++){g.push(l[f].leavetimes/l[f].sumtimes);}for(var k=0;k<h.length;k++){var d=h[k].getContext("2d");!e&&d.scale(2,2);d.clearRect(0,0,112,112);
(function(m,i,n,p){var o=0;var q=setInterval(function(){m.clearRect(0,0,112,112);n.drawCircel(m,70,56,25,0,2*Math.PI);o++;n.drawCircel(m,70,56,25,-(30*2/360)*Math.PI,2*Math.PI*((g[i]/10)*o),"#625593",p);
if(o>=10){clearInterval(q);}},50);})(d,k,this,l[k].leavetimes==-99?"不限":l[k].leavetimes);}},getTime:function(j){try{var f=new Date(j);var g=f.getFullYear();
var i=f.getMonth()+1;var d=f.getDate();return g+"."+i+"."+d;}catch(h){}},getfileTime:function(g){var j,f,i;var e=parseInt(am.now().getTime()/1000);var h;
h=e-g;i=parseInt(h/86400);f=parseInt(h/3600);j=parseInt(h/60);d_s=parseInt(h);if(i>0){return i+"天";}else{if(i<=0&&f>0){return f+"小时";}else{if(f<=0&&j>0){return j+"分钟";
}else{return"刚刚";}}}},renderOurselves:function(e){if(e){a.fileBoxIndex=0;a.$fileul.find(".listbox").remove();a.fileScroll.scrollTo("top");}var d=this.$fileBox.find(".leftTit span.selected").index();
if(d==0){this.$fileBox.find(".leftTit span.addphoto").text("添加说说");}else{this.$fileBox.find(".leftTit span.addphoto").text("添加照片");}this.getarchivesData(function(h){if(h.content&&h.content.length){a.fileBoxIndex++;
var m=h.content;for(var g=0;g<m.length;g++){var l=m[g],o=a.$fileli.clone(true,true);if(d==0){o.find(".right .words p").text(l.archives);o.find(".outher").text(l.userName);
}else{o.find(".outher").text(l.empName);o.find(".right .words p").text(l.title);o.find(".imglist ul").empty();console.log(l);var k=l.photo.split(",");if(k&&k.length){for(var f=0;
f<k.length;f++){var n=a.$imgBoxli.clone(true,true);n.html(am.photoManager.createImage("show",{catigoryId:l.type,parentShopId:l.parentShopId,authorId:l.empId},k[f],"s"));
o.find(".imglist ul").append(n);}}}if(a.getfileTime(l.createTime/1000)=="刚刚"){o.find(".left .key").text("上传");}o.find(".left .value").text(a.getfileTime(l.createTime/1000));
a.$fileul.append(o);}if(d==0){a.$fileBox.find(".imglist").hide();}else{a.$fileBox.find(".imglist").show();}if(a.fileBoxSize>h.content.length){a.fileScroll.pauseTouchBottom=true;
}else{a.fileScroll.pauseTouchBottom=false;}a.$.find(".filebody").removeClass("empty cutting");}else{if(h.pageIndex==0){a.$.find(".filebody").removeClass("cutting").addClass("empty");
}else{am.msg("没有更多啦！");}a.fileScroll.pauseTouchBottom=true;}a.fileScroll.pauseTouchTop=false;a.fileScroll.refresh();a.fileScroll.closeTopLoading();a.fileScroll.closeBottomLoading();
});},renderCard:function(){var k=this.cardCash;var e=a.$userInfo.treatMentItems;var n=this.$cardul;var s=["type_zero","type_one","type_two"];n.empty();
this.$comboul.empty();if(k.length){for(var m=0;m<k.length;m++){var r=k[m],p=this.$cardLi.clone(true,true);p.find(".info_left .card_name").text(r.cardtypename);
p.find(".info_left .card_no").text(r.cardid);if(r.cardtype!="2"){p.find(".info_right").removeClass("hasnofee");p.find(".card_fee .fee_num").html("￥"+am.cashierRound(r.cardfee));
p.find(".card_present .fee_num").html("￥"+am.cashierRound(r.presentfee));}else{p.find(".info_right").addClass("hasnofee");}if(r.invaliddate){var q="到期日："+new Date(r.invaliddate-0).format("yyyy.mm.dd");
}else{var q="到期日：无";}p.find(".duedatewrap .duedate").text(q);if(r.cardtypeid=="20151212"||r.cardtypeid=="20161012"){p.find(".duedatewrap .duedateedit").hide();
}if(am.operateArr.indexOf("Z")==-1){p.find(".duedatewrap .duedateedit").hide();}p.data("item",r);if(a.selectCardId&&a.selectCardId==r.id){p.addClass("selected");
}if(r.cardtype==1&&(r.timeflag==0||r.timeflag==2)){p.find(".free .value").addClass("pay");}if(r.cardRemark){p.find(".remarkWrap .remarkCon .text").html(r.cardRemark);
}if((r.cardtype=="1")){if(r.timeflag=="2"){p.addClass("type_zero");}else{p.addClass("type_one");}}else{p.addClass("type_two");}if(r.timeflag!="0"){p.find(".balanceedit").hide();
p.find(".giftmoneyedit").hide();}if(am.operateArr.indexOf("A")==-1){p.find(".balanceedit").hide();p.find(".giftmoneyedit").hide();}n.append(p);}var o=this.$cardLi.clone(true,true);
o.find(".card_base_info,.duedatewrap").css("opacity",0).end().find(".free .key,.free").empty().end().addClass("addcard");n.append(o);}else{var o=this.$cardLi.clone(true,true);
o.find(".card_base_info,.duedatewrap").css("opacity",0).end().find(".free .key,.free").empty().end().addClass("addcard");n.append(o);}if(e.length){this.$comboBox.removeClass("empty");
var g=this.$comboli.clone(true,true);g.data("memberid",e.id);var t=g.find("ul");t.empty();for(var h=0;h<e.length;h++){var d=e[h];var j=this.$combolii.clone(true,true);
if(d.isNewTreatment&&d.timesItemNOs){d.itemname=am.page.comboCard.getItemNamesByNos(d.timesItemNOs).join(",");}if(d.itemRemark){j.find(".comboRemark .remarkCon .text").html(d.itemRemark);
}j.find(".left .key").html((d.treattype==1?'<strong class="highlight">[赠] </strong>':"")+"<span class='combo_tit'><span class='combo_text'>"+(d.itemname||" ")+"</span>(<b class='combo_times'>"+((d.sumtimes==0||d.sumtimes==-99)?"不限":d.sumtimes)+"</b>次)</span><span class='back_combo am-clickable'>退</span>");
j.find(".left .value").html((d.validdate?('<span class="duedate">到期日：'+a.getTime(d.validdate)+'</span><span class="treatmentdateedit am-clickable"></span>'):('<span class="duedate">不限期</span><span class="treatmentdateedit am-clickable"></span>')));
t.append(j);j.data("item",d);if(am.operateArr.indexOf("Z")==-1){j.find(".left .value .treatmentdateedit").hide();}if(am.operateArr.indexOf("a7")==-1){j.find(".left .key .back_combo").hide();
}}this.$comboul.append(g);}if(!this.$comboul.find(".list")||!this.$comboul.find(".list").length){this.$comboBox.addClass("empty");}else{var f=e;this.renderCircle(f);
}this.cardScroll.refresh();this.cardScroll.scrollTo("top");this.comboScroll.refresh();this.comboScroll.scrollTo("top");this.$cardBox.find(".duedatewrap .duedateedit").mobiscroll().calendar({theme:"mobiscroll",lang:"zh",display:"bottom",months:"auto",setOnDayTap:true,buttons:[],onSet:function(u,x){var l=u.valueText;
var w=c(this).parents("li");var v=w.data("item");console.log(l);console.log(v);var i={memberCardId:v.id,validate:new Date(l).getTime(),oldDate:v.invaliddate?v.invaliddate:"",operator:amGloble.metadata.userInfo.userName,shopId:amGloble.metadata.userInfo.shopId+"",cardNo:v.cardid};
console.log(i);am.loading.show("修改中,请稍候...");am.api.invalidateUpdate.exec(i,function(z){am.loading.hide();console.log(z);if(z.code==0){var y=new Date(i.validate).format("yyyy.mm.dd");
w.find(".duedate").text("到期日："+y);v.invaliddate=i.validate;w.data("item",v);}else{am.msg(z.message||"数据获取失败,请检查网络!");}});}});this.$comboBox.find(".list .treatmentdateedit").mobiscroll().calendar({theme:"mobiscroll",lang:"zh",display:"bottom",months:"auto",setOnDayTap:true,buttons:[],onSet:function(u,x){var l=u.valueText;
var w=c(this).parents("li");var v=w.data("item");console.log(l);console.log(v);var i={itemId:v.id,validate:new Date(l).getTime(),oldDate:v.validdate?v.validdate:"",operator:amGloble.metadata.userInfo.userName,shopId:amGloble.metadata.userInfo.shopId+"",cardNo:v.cardno};
console.log(i);am.loading.show("修改中,请稍候...");am.api.invalidateUpdate.exec(i,function(z){am.loading.hide();console.log(z);if(z.code==0){var y=new Date(i.validate).format("yyyy.mm.dd");
w.find(".value .duedate").text("到期日："+y);v.validdate=i.validate;w.data("item",v);}else{am.msg(z.message||"数据获取失败,请检查网络!");}});}});},renderRecord:function(d){if(d){this.recordIndex=1;
}a.getlistServiceData(function(m){console.log(m);if(m.content&&m.content.length){a.$table.empty();for(var l=0;l<m.content.length;l++){var q=m.content[l];
var h=c('<tr><td style="width:10%"><div class="tdwrap">'+(q.billno||"")+'</div></td><td style="width:9%"><div class="tdwrap price">￥'+(q.expense*1==0?0:q.expense)+'</div></td><td style="width:33%"><div class="tdwrap addproject"></div></td><td style="width:11%"><div class="tdwrap">'+am.time2str(q.createDate/1000)+'</div></td><td style="width:12%"><div class="tdwrap">'+a.getshopName(q.storeId)+'</div></td><td style="width:13%"><div class="tdwrap empName"></div></td><td style="width:6%"><div class="signature am-clickable" data-memberid="'+q.custId+'" data-storeid="'+q.storeId+'" data-billid="'+q.id+'">查看</div></td><td style="width:6%"><div class="comment am-clickable selected iconfont icon-comments"><span class="comment-content"></span></div></td></tr>').data("item",q);
if(q.items&&q.items.length){var g=false;for(var k=0;k<q.items.length;k++){var e=q.items[k];var o=e.serviceItemName+(q.expenseCategory==1?" x"+(e.num+" "):"");
if((q.expenseCategory==4&&e.consumeType==1)||(q.expenseCategory==6&&q.consumeType==-1&&e.consumeType==4)){o=o+(e.num+"次 ");}else{var f=am.cashierRound(e.price);
var n="";if(e.largess&&e.largess>0){n="(赠送金:"+e.largess+"元)";}o=o+" "+((isNaN(f)?itemsj.price:f)+"元"+n);}h.find(".addproject").append("<span>"+o+"</span>");
if(!g&&e.emps.length){h.find(".empName").text(e.emps[0].empName);g=true;}}}if(q.expenseCategory==0||q.expenseCategory==1||(q.expenseCategory==6&&q.consumeType==-1)||(q.expenseCategory==4&&q.consumeType==-1)){}else{h.find(".signature").addClass("am-disabled");
}a.$table.append(h);a.$table.append('<tr class="comment-content"><td colspan="8"><div class="arrow"></div>'+(q.comment||"")+"</td></tr>");if(!q.comment){h.find(".comment").addClass("am-disabled");
}a.$recordBox.removeClass("cutting empty");}}else{a.$recordBox.removeClass("cutting").addClass("empty");}a.tableScroll.refresh();a.tableScroll.scrollTo("top");
a.pager.refresh(a.recordIndex-1,m.count);});},getLength:function(d){return String(d).replace(/[^\x00-\xff]/g,"aa").length;},mySubStr:function(j,f){var e=0;
var d="";for(var g=0;g<j.length;g++){var h=j.charAt(g);e+=this.getLength(h);if(e>f){break;}d+=j.charAt(g);}return d;},renderUserInfo:function(f){var d=this;
if(f.content){var g=f.content.memberInfo;this.$leftBox.data("item",g);this.$leftBox.find(".header_box").html(am.photoManager.createImage("customer",{parentShopId:am.metadata.userInfo.parentShopId,updateTs:g.lastphotoupdatetime||new Date().getTime()},g.id+".jpg","s")).end().find(".name .username").text(g.name).end().find(".mobile").text(g.mobile).end().find(".shops").text(d.getshopName(g.shopid)||"");
if(g.page){if(this.getLength(g.page)>88){this.$leftBox.find(".remarks").data("remarks",g.page).html(d.mySubStr(g.page,88)+'...<a href="javascript:;" class="more am-clickable">更多</a><a href="javascript:;" class="edit am-clickable">修改</a>');
}else{this.$leftBox.find(".remarks").data("remarks",g.page).html(g.page+'<a href="javascript:;" class="edit am-clickable">修改</a>');}}if(g.sex=="F"){this.$leftBox.find(".name .ico").addClass("womanico");
}else{this.$leftBox.find(".name .ico").removeClass("womanico");}var e=this.$leftBox.find(".listbox .list li");e.eq(0).find(".value").text((g.avgfee*1==0?0:g.avgfee.toFixed(2))+"元");
e.eq(1).find(".value").text(g.mgjconsumeperiod+"天");e.eq(2).find(".value").text((g.lastconsumetime||g.mgjlastcashiertime)?am.time2str((g.lastconsumetime||g.mgjlastcashiertime)/1000):"--");
e.eq(3).find(".value").text(g.mgjlastserver?g.mgjlastserver:"暂无");if(!g.classid){this.$leftBox.find(".listbox .title_words").text("");}else{this.$leftBox.find(".listbox .title_words").text(d.getmemberLevel(g.classid));
}this.$memberInfo=g;console.log("this.$memberInfo",g);this.$leftBox.find(".excbox .num").text(g.currpoint?g.currpoint:0).parent().data("point",g.currpoint?g.currpoint:0);
}else{throw new Error("userinfo is null");}},getmemberLevel:function(g){var f=am.metadata.memberClass;if(f&&f.length){for(var d=0;d<f.length;d++){var e=f[d];
if(e.classid==g){return e.classname;}}}},getshopName:function(g){var d=am.metadata.shopList;if(d&&d.length){for(var e=0;e<d.length;e++){var f=d[e];if(f.shopId==g){return f.osName;
}}}},drawCircel:function(l,k,j,d,g,e,f,i,h){l.beginPath();l.lineWidth=4;l.strokeStyle=f?f:"#eeeeee";l.arc(k,j,d,g,e);l.stroke();l.beginPath();l.textAlign="center";
l.font="10px 华文细黑";l.fillStyle="#999";l.fillText("剩余",70,68);l.stroke();l.beginPath();l.textAlign="center";l.font="13px Helvetica";l.fillStyle="#222222";
l.fillText((i?(i+"次"):""),70,55);l.stroke();},clearModelBox:function(){this.adboxSelectedCategory="";this.adboxSelectedSubCategory="";this.adboxSelectedProductId="";
this.adboxSelectedProductName="";this.adboxSelectedProductTid="";this.$adbox.find(".link_box").removeClass("hide");this.$adbox.find(".linked_box").addClass("hide");
this.$adbox.find("input[name='workPrice']").val("");this.$adbox.find("input[name='workPrice']").val("");this.$adbox.find("textarea[name='talk_content']").val("");
this.$adbox.find(".mbody-left .photo_typebox>ul>li").removeClass("selected");this.$adbox.find(".photo_upload_boxs ul").html('<li class="empty_box am-clickable"></li>');
this.$adbox.find(".left-dot").removeClass("selected");this.$adbox.addClass("hide");this.$azbox.addClass("hide");this.$arbox.addClass("hide");this.$azbox.find("textarea[name='addqzone_qzone_content']").val("");
this.$arbox.find("textarea[name='addremark_qzone_content']").val("");this.$adbox.find("input[name='showInMYKSwitch']").prop("checked",false);this.renderOurselves(true);
},getData:function(f){var e=am.metadata;var d=this.$data;am.loading.show("正在获取数据,请稍候...");am.api.memberDetails.exec({shopId:d.shopId,memberid:d.customerId,parentShopId:am.metadata.userInfo.parentShopId},function(g){am.loading.hide();
console.log(g);if(g.code==0){a.cardCash=g.content.cards;a.$userInfo=g.content.memberInfo;a.memberpw=a.$userInfo.passwd;if(am.operateArr.indexOf("MGJP")!=-1){a.$userInfo.realMobile=a.$userInfo.mobile;
a.$userInfo.mobile=a.$userInfo.mobile.replace(/\d{4}$/,"****");}f&&f(g);}else{am.msg(g.message||"数据获取失败,请检查网络!");}});},getlistServiceData:function(f){var e=am.metadata;
var d=this.$data;am.loading.show("正在获取数据,请稍候...");am.api.listService.exec({shopId:am.metadata.userInfo.shopId,memberid:d.customerId,parentShopId:am.metadata.userInfo.parentShopId,pageNumber:a.recordIndex,pageSize:15,timeUnLimit:1},function(g){am.loading.hide();
console.log(g);if(g.code==0){f&&f(g);}else{a.$recordBox.removeClass("empty").addClass("cutting");am.msg(g.message||"数据获取失败,请检查网络!");}});},submitCraft:function(d){amGloble.loading.show();
amGloble.api.addInvention.exec(d,function(e){amGloble.loading.hide();if(e&&e.code==0){amGloble.msg("添加成功");a.clearModelBox();}else{amGloble.msg(e.message||"提交失败");
}});},submitArchives:function(d){amGloble.loading.show();amGloble.api.customerAddArchives.exec(d,function(e){amGloble.loading.hide();if(e&&e.code==0){amGloble.msg("添加成功");
a.clearModelBox();}else{amGloble.msg(e.message||"提交失败");}});},submitRemark:function(e,d){amGloble.loading.show();if(d=="card"){amGloble.api.saveCardRemark.exec(e,function(f){amGloble.loading.hide();
if(f&&f.code==0){amGloble.msg("添加成功");a.clearModelBox();a.$changeTarget.find(".remarkWrap .remarkCon .text").html(e.cardRemark);var g=a.$changeTarget.data("item");
g.cardRemark=e.cardRemark;a.$changeTarget.data("item",g);}else{amGloble.msg(f.message||"提交失败");}});}else{if(d=="combo"){amGloble.api.saveComboRemark.exec(e,function(f){amGloble.loading.hide();
if(f&&f.code==0){amGloble.msg("添加成功");a.clearModelBox();a.$changeTarget.find(".comboRemark .remarkCon .text").html(e.itemRemark);var g=a.$changeTarget.data("item");
g.itemRemark=e.itemRemark;a.$changeTarget.data("item",g);}else{amGloble.msg(f.message||"提交失败");}});}}a.$.find("[isdisabled=1]").addClass("am-clickable");
},getMallItemData:function(e){var d=this;if(this.queryMallItemCache){e(this.queryMallItemCache);return;}amGloble.api.queryMallItem.exec({category:1,parentShopId:amGloble.metadata.userInfo.parentShopId},function(f){if(f.code==0){d.queryMallItemCache=f.content;
e(f.content);}else{amGloble.msg(f.message||"数据获取失败,请重试!");}});},getarchivesData:function(h){var f=am.metadata;var e=this.$data;var d=this.$fileBox.find(".leftTit span.selected").index();
var g=["archivesList","inventionList"];am.loading.show("正在获取数据,请稍候...");am.api[g[d]].exec({shopId:am.metadata.userInfo.shopId,memberid:e.customerId,parentShopId:am.metadata.userInfo.parentShopId,pageNumber:a.fileBoxIndex,pageSize:a.fileBoxSize},function(i){am.loading.hide();
console.log(i);if(i.code==0){h&&h(i);}else{a.$.find(".filebody").removeClass("empty").addClass("cutting");am.msg(i.message||"数据获取失败,请检查网络!");}});},renderCredit:function(){var f=am.metadata.shopAwards;
for(var e=0;e<f.length;e++){var d=c('<div class="changebox am-clickable"><span class="change_icon"></span><span class="change_words">'+f[e].name+'</span><span class="change_num">'+f[e].point+"积分</span></div>").data("item",f[e]);
a.$exbox.find(".goodlist .exinner").append(d);}},exchangePoint:function(){if(a.$.find(".changebox.selected").length==0){amGloble.msg("请选择要兑换的商品");return;
}var e=a.$.find(".changebox.selected").data("item");var d=a.$leftBox.find(".excbox .exchange").data("point")-e.point;var f=this.$data;if(d<0){amGloble.msg("当前用户积分不足以兑换此商品！");
return;}amGloble.confirm("商品兑换","确定兑换此商品么，一旦兑换不可更改","确定","返回",function(){var g={shopId:amGloble.metadata.userInfo.shopId,member:{id:f.customerId,cardid:f.cardId||"",mobile:a.$userInfo.mobile},shopAward:{name:e.name,point:e.point}};
amGloble.loading.show("正在兑换商品,请稍候...");amGloble.api.expendPoint.exec(g,function(h){if(h.code==0){am.loading.hide();amGloble.msg("积分兑换成功！");a.$exbox.addClass("hide");
a.$leftBox.find(".excbox .exchange .num").text(d).parent().data("point",d);a.$userInfo.currpoint=d;console.log(a,a.$userInfo);}else{am.msg(h.message||"数据获取失败,请检查网络!");
}});},function(){});},eidtPrivilegeTime:function(){am.loading.show("正在获取数据，请稍候...");var d=amGloble.now();if(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("expireDate")&&a.$memberInfo.privilege.expireDate!=null){d=new Date(a.$memberInfo.privilege.expireDate);
}var f=a.privilegeCardSelect.getValue();if(f==1){d.setMonth(d.getMonth()+1);}else{if(f==3){d.setMonth(d.getMonth()+3);}else{if(f==6){d.setMonth(d.getMonth()+6);
}else{if(f==12){d.setMonth(d.getMonth()+12);}else{if(f==-1){d=null;}else{if(f==0){d=new Date(a.$endInput.val());}}}}}}var e={parentShopId:a.$memberInfo.parentshopid,shopId:a.$memberInfo.shopid,openShopId:amGloble.metadata.userInfo.shopId,optId:amGloble.metadata.userInfo.userId,optName:amGloble.metadata.userInfo.userName,privilegeId:(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("id"))?a.$memberInfo.privilege.id:null,ownerId:a.$memberInfo.id,ownerName:a.$memberInfo.name,mobile:a.$memberInfo.mobile,createtime:new Date(a.$startInput.val()).getTime(),expireDate:d!=null?d.getTime():null,targetDate:d!=null?d.getTime():null,};
if(a.$memberInfo.privilege!=null&&a.$memberInfo.privilege.hasOwnProperty("ownerId")&&a.$memberInfo.id==a.$memberInfo.privilege.ownerId){e={parentShopId:a.$memberInfo.parentshopid,shopId:a.$memberInfo.shopid,openShopId:amGloble.metadata.userInfo.shopId,optId:amGloble.metadata.userInfo.userId,optName:amGloble.metadata.userInfo.userName,privilegeId:a.$memberInfo.privilege.id,expireDate:a.$memberInfo.privilege.expireDate,targetDate:d!=null?d.getTime():null,};
}am.api.editPrivilege.exec(e,function(g){am.loading.hide();if(g.code==0){am.msg("成功,顾客特权卡有效期至"+(d!=null?d.format("yyyy-mm-dd"):"不限期"));}else{am.msg(g.message||"数据获取失败，请重试！");
}a.$privilegeCardBox.addClass("hide");if(!a.$privilegeCardBox.find(".validDate .item_input").hasClass("hide")){a.$privilegeCardBox.find(".validDate .item_input").addClass("hide");
}a.beforeShow({customerId:a.$memberInfo.id,tabId:1});});}});var b=function(d){this.$parent=d.$;this.$popupTit=this.$parent.find(".popup_tit");this.$exchange=this.$parent.find(".toCard_tit");
this.$inputWrap=this.$parent.find(".card_trans_total");this.outCard=null;this.inCard=null;this.onRender=d.onRender;this.onCheck=d.onCheck;this.onSubmit=d.onSubmit;
this.onChangeMemory=d.onChangeMemory;this.disabled=false;this.type=d.type;this._bindEvt();if(this.type==1){this._bindCardInput();}else{this.cards=d.ownCards;
this._bindSelect();this._bindComboInput();}};b.prototype={constructor:b,init:function(d){this.render(d);this.outCard=d;if((d.sumtimes==0||d.sumtimes==-99)||(d.leavetimes==0||d.leavetimes==-99)){this.disabled=true;
this.$inputWrap.addClass("disabled");}else{this.disabled=false;this.$inputWrap.removeClass("disabled");}},render:function(d){this.onRender(this.$parent.find(".card_from"),d);
},_bindEvt:function(){var d=this;this.$parent.on("keyup",".win_input",function(f){if(f.keyCode==13){d.search();}}).on("vclick",".search_icon",function(){d.search();
}).on("vclick",".trans_fee input,.trans_pfee input",function(){var e=this;if(d.disabled&&c(this).parent().hasClass("trans_fee")){am.msg("不限次的套餐，只需要输入退款金额！");
return;}am.keyboard.show({title:"请输入数字",hidedot:false,submit:function(f){c(e).val(f);}});}).on("vclick",".sure_btn",function(){d.submit();}).on("vclick",".btn_cancel",function(){d.hide();
}).on("vclick",".popup_right_mask",function(){d.hide();});},_bindCardInput:function(){this.$parent.on("vclick",".trans_fee input,.trans_pfee input",function(){var d=this;
am.keyboard.show({title:"请输入数字",hidedot:false,submit:function(e){c(d).val(e);}});});},_bindComboInput:function(){var d=this;this.$parent.on("vclick",".trans_fee input,.trans_pfee input",function(){var e=this;
if(c(this).parent().hasClass("trans_fee")){if(d.disabled){am.msg("不限次的套餐，只需要输入退款金额！");return;}am.keyboard.show({title:"请输入数字",hidedot:true,submit:function(f){c(e).val(f);
}});}else{am.keyboard.show({title:"请输入数字",hidedot:false,submit:function(f){c(e).val(f);}});}}).on("vclick",".toCard_card",function(){c(this).addClass("open");
});},_bindSelect:function(){var d=this;this.$parent.on("vclick",".toCard_card",function(){var e=d.findRelatedCard(d.cards);console.log(e);if(!e){d.listFromOwn(d.cards);
}else{d.renderFoundedData(e);}});},show:function(f,g,d){a.$.find("[isdisabled=1]").removeClass("am-clickable");this.reset();this.$parent.addClass("show");
this.init(f);this.$targetCard=g;if(this.type==1){if(d){var e=c("body").outerHeight();a.$cardfeePopup.css({height:e+"px",position:"absolute",top:0,bottom:"auto"});
this.$popupTit.text("卡金转入");this.isExchange=true;this.exchangeDom();}else{var e=c("body").outerHeight();a.$cardfeePopup.css({height:e+"px",position:"absolute",top:"auto",bottom:0});
this.isExchange=false;this.$popupTit.text("卡金转出");}}else{this.isExchange=false;this.cards=a.cardCash;}},exchangeDom:function(){var e=this.$exchange.prev().remove();
var d=this.$exchange.next().remove();this.$exchange.before(d.clone(true,true));this.$exchange.after(e.clone(true,true));},hide:function(){this.isExchange&&this.exchangeDom();
this.$parent.removeClass("show");this.reset();setTimeout(function(){a.$.find("[isdisabled=1]").addClass("am-clickable");},500);},reset:function(){this.onRender(this.$parent.find(".card_from"),null);
this.$parent.find(".card_to").addClass("init");this.$parent.find(".card_to").data("inCard",null);this.$parent.find(".win_input").val("");this.$inputWrap.find(".trans_fee input,.trans_pfee input").val("");
this.outCard=null;this.inCard=null;},search:function(){var d=this.getshopIds(am.metadata.userInfo.shopId);var e=this.$parent.find(".win_input").val(),f=this;
if(e==""){am.msg("请输入搜索关键字！");return;}am.loading.show("正在获取数据，请稍候...");am.api.searchmember.exec({parentShopId:am.metadata.userInfo.parentShopId,shopId:am.metadata.userInfo.shopId,shopIds:d,keyword:e,pageSize:1500,pageNumber:0},function(g){am.loading.hide();
if(g.code==0){f.listFromSearch(g.content);}else{f.listFromSearch();am.msg(g.message||"数据获取失败，请重试！");}});},findRelatedCard:function(d){var f=this,e=null;
console.log(d,this.outCard.memcardid);c.each(d,function(g,h){if(f.outCard.memcardid==h.id){e=h;}});return e;},listFromOwn:function(d){var f="请选择一张卡！",g=this;
var e=[];if(d&&d.length>0){if(d.length==1){g.renderFoundedData(d[0]);}else{e=this.transToMenu(d);am.popupMenu(f,e,function(h){console.log(h);g.renderFoundedData(h.value);
});}}else{am.msg("没找到卡！");g.$parent.find(".card_to").addClass("init");}},listFromSearch:function(e,d){var g="请选择一张卡！",h=this;var f=[];e=this.convertSearchCardToMemberDetailCards(e);
if(e&&e.length>0){if(e.length==1){this.renderFoundedData(e[0]);}else{f=this.transToMenu(e);am.popupMenu(g,f,function(i){console.log(i);h.renderFoundedData(i.value);
});}}else{am.msg("没找到卡！");h.$parent.find(".card_to").addClass("init");}},transToMenu:function(g){console.log(g);var e=[];for(var d=0;d<g.length;d++){var f=g[d];
if(f.cardtype!="2"&&f.timeflag!="1"){e.push({name:(f.name||"")+(f.name?"-":"")+f.cardtypename+" ("+f.cardid+")",value:f});}}return e;},renderFoundedData:function(d){if(d.cardtype!="2"&&d.timeflag!="1"){am.msg("找到卡了！");
this.$parent.find(".card_to").removeClass("init").removeClass("open").data("inCard",d);this.inCard=d;this.$parent.find(".card_to").find(".card_name").html(d.cardtypename).end().find(".card_no").html(" ("+d.cardid+") ").end().find(".card_fee").html("卡金："+am.cashierRound(d.cardfee)).end().find(".card_pfee").html("赠金："+am.cashierRound(d.presentfee)).end().find(".card_osName").html("开卡门店："+(a.getshopName(d.shopid).replace(/\s/g,"")||"门店名称未设定"));
}else{am.msg("资格卡和计次卡不能用来转账！");}},submit:function(){var e=this,d=null;if(this.isExchange){d=this.onCheck(this.$inputWrap,this.outCard,this.inCard);}else{d=this.onCheck(this.$inputWrap,this.inCard,this.outCard);
}if(!d){return;}this.onSubmit(d,function(){if(e.isExchange){e.onChangeMemory(e.$targetCard,e.outCard,e.inCard,d);}else{e.onChangeMemory(e.$targetCard,e.inCard,e.outCard,d);
}e.hide();},function(){e.hide();});},getshopIds:function(g){var f=[];var d=am.metadata.shopList;for(var e=0;e<d.length;e++){f.push(d[e].shopId);}return f.join(",");
},convertSearchCardToMemberDetailCards:function(e){var d=[];c.each(e,function(g,f){d.push({cardid:f.cardNo,cardtypename:f.cardName,name:f.name||"",id:f.cid,memberid:f.id,cardfee:f.balance,presentfee:f.gift,cardtype:f.cardtype,timeflag:f.timeflag,shopid:f.shopId});
});return d;},};})(jQuery);