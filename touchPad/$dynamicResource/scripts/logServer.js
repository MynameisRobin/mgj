!function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n,o){var a=null;window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP")),null!=a?(a.open(e,t,!0),a.setRequestHeader("Content-Type","application/json"),null!=n&&JSON.stringify(n)&&(n=JSON.stringify(n)),a.send(n),a.onreadystatechange=function(){4==a.readyState&&o(a)}):alert("Your browser does not support XMLHTTP.")}},function(e,t,n){"use strict";var o={};o=window.location.href.indexOf("http://localhost:8086/")>-1?{logServer:"http://localhost:8081",logPort:"8081",infoTXT:"Info.txt",interface:[]}:{logServer:"http://log.meiguanjia.net",logPort:"80",infoTXT:"Info.txt",interface:[]},e.exports=o},function(e,t,n){"use strict";var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=l(n(3)),i=l(n(0));function l(e){return e&&e.__esModule?e:{default:e}}var c,s=n(1);console.log("clientConfig",s);var u=null,d="",f="";function g(){return/(iOS)/i.test(navigator.userAgent)?"iOS":/(iPhone)/i.test(navigator.userAgent)?"iPhone":/(iPad)/i.test(navigator.userAgent)?"iPad":/(Android)/i.test(navigator.userAgent)?"Android":"PC"}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return a(e,[{key:"_setOptins",value:function(e){return c=o({},c,e)}}],[{key:"_init",value:function(){localStorage.MGJ_LOGID||(localStorage.MGJ_LOGID=(new Date).getTime()+"-"+Math.floor(4096*Math.random()));var t=document.querySelector("#UPLOADLOG");t&&(t.onclick=function(){console.log("manual UPLOADLOG"),function(e,t){console.log("addShopId"),console.log(e),(0,i.default)("POST",s.logServer+"/addShopId",e,function(n){var o=JSON.parse(n.responseText);console.log(o),"0"==o.code&&(console.log(e[0].app+"-"+e[0].shopId+"已添加"),t&&t())})}([{app:e._getAppType(d),shopId:e._getShopId()}],function(){v(c=o({deviceId:localStorage.getItem("MGJ_LOGID"),appId:d,appVersion:f,platfrom:g()},c),function(e){h(e,1),u&&clearInterval(u),u=setInterval(function(){h(e)},e.content.logSyncTime)})})}),new Promise(function(e,t){(0,i.default)("GET",""+s.infoTXT,null,function(t){e(t)})}).then(function(t){var n,a,r=JSON.parse(t.responseText);c=o({deviceId:localStorage.getItem("MGJ_LOGID"),appId:r.id,appVersion:r.version,platfrom:g()},c),d=r.id,f=r.version,n={app:e._getAppType(d),shopId:e._getShopId()},a=function(){v(c,function(e){u&&clearInterval(u),u=setInterval(function(){h(e)},e.content.logSyncTime)})},console.log("start check"),(0,i.default)("POST",s.logServer+"/getShopId",n,function(e){var t=JSON.parse(e.responseText);console.log(t),"0"==t.code&&t.content&&t.content.length&&(console.log("check pass"),console.log("查询到"+n.app+"-"+n.shopId+"已配置"),a&&a())})}).catch(function(e){console.log("Failed: "+e)})}},{key:"_saveLog",value:function(t,n){var a={doWhat:"addData",data:[o({},c,t,{shopId:e._getShopId()})]};n?r.default._callFun(a,function(){e.postFun()}):r.default._callFun(a,null)}},{key:"postFun",value:function(){r.default._callFun({doWhat:"getAllData"},function(e){var t={logs:JSON.stringify(e)};(0,i.default)("POST",s.logServer+"/saveUserLogs",t,function(e){var n=JSON.parse(e.responseText);"0"==n.code?r.default._callFun({doWhat:"deleteData",data:JSON.parse(t.logs)}):console.log(n)})})}},{key:"_rewriteConsole",value:function(t){var n=window.console;t.map(function(t,o,a){n["_"+t]=n[t],n[t]=function(){var o=Array.prototype.slice.apply(arguments);e._saveLog({level:t,content:o.join("|"),ts:(new Date).getTime()}),n["_"+t].apply(n,o)}})}},{key:"_getShopId",value:function(){var e="";try{e=JSON.parse(localStorage.userToken).shopId}catch(e){console.log(e)}return e.toString()}},{key:"_getAppType",value:function(e){return e.indexOf("touchPad")?"touchPad":e.indexOf("shengyibao")?"BusinessApp":void 0}}]),e}();function v(e,t){(0,i.default)("POST",s.logServer+"/logSetting",e,function(e){var n=JSON.parse(e.responseText);console.log(n),"0"==n.code?t&&t(n):console.log(n)})}function h(e,t){r.default._callFun({doWhat:"getAllData"},function(n){var o={logs:[]},a=(new Date).getTime(),l=n,c=n;c.length>=e.content.logNum&&(c=c.slice(-e.content.logNum)),c.forEach(function(n,r,i){(a-n.ts>=e.content.logSyncTime||t)&&o.logs.push(n)}),o.logs.length>0&&(0,i.default)("POST",s.logServer+"/saveUserLogs",o,function(e){var n=JSON.parse(e.responseText);"0"==n.code?(r.default._callFun({doWhat:"deleteData",data:l}),t&&alert("上传成功")):console.log(n)})})}p._init(),p._rewriteConsole(["debug","warn","error","info","trace"]),window.LogPlug=new p,window.onerror=function(e,t,n,o,a){var r={level:"error",ts:(new Date).getTime(),content:e+" \n scriptURI: "+t+" \n lineNumber: "+n+" \n columnNumber: "+o};p._saveLog(r,"同步")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o={name:"logServerDB",version:9,db:null,ojstore:{name:"logList",keypath:"id"}},a={indexedDB:window.indexedDB||window.webkitindexedDB,IDBKeyRange:window.IDBKeyRange||window.webkitIDBKeyRange,openDB:function(e,t,n){var a=t||1,r=this.indexedDB.open(e,a);r.onerror=function(e){console.log(e.currentTarget.error.message)},r.onsuccess=function(e){o.db=e.target.result},r.onupgradeneeded=function(e){var t=e.target.result;e.target.transaction;t.objectStoreNames.contains(o.ojstore.name)||t.createObjectStore(o.ojstore.name,{keyPath:o.ojstore.keypath,autoIncrement:!0})}},deletedb:function(e){this.indexedDB.deleteDatabase(e)},closeDB:function(e){e.close()},maxLength:500,list:[],addData:function(e,t,n,o){var a=this;if(this.getDataByKey(e,t,{},function(o){if(o.length+n.data.length>a.maxLength){var r=o.splice(0,o.length+n.data.length-a.maxLength);a.deleteData(e,t,{data:r})}}),this.list=this.list.concat(n.data),e)for(var r,i=i=e.transaction(t,"readwrite").objectStore(t);this.list.length;){var l=this.list.shift();null!=l.content&&((r=i.add(l)).onerror=function(){},r.onsuccess=function(){"function"==typeof o&&o()})}},upData:function(e,t,n){for(var o,a=a=e.transaction(t,"readwrite").objectStore(t),r=0;r<n.data.length;r++)(o=a.put(n.data[r])).onerror=function(){},o.onsuccess=function(){}},getDataByKey:function(e,t,n,o){var a,r=e.transaction(t,"readwrite").objectStore(t);(a=n.key?r.get(n.key):r.getAll()).onerror=function(){},a.onsuccess=function(e){var t=e.target.result;o(t)}},deleteData:function(e,t,n,o){for(var a,r=r=e.transaction(t,"readwrite").objectStore(t),i=0;i<n.data.length;i++)(a=r.delete(n.data[i].id)).onerror=function(){},a.onsuccess=function(){"function"==typeof o&&o()}},clearData:function(e,t){e.transaction(t,"readwrite").objectStore(t).clear(),console.log("已删除存储空间"+t+"全部记录")},_callFun:function(e,t){!function(e,t){setTimeout(function(){switch(e.doWhat){case"addData":a.addData(o.db,o.ojstore.name,e,t);break;case"upData":a.upData(o.db,o.ojstore.name,e,t);break;case"getAllData":a.getDataByKey(o.db,o.ojstore.name,e,t);break;case"deleteData":a.deleteData(o.db,o.ojstore.name,e,t);break;case"clearData":a.clearData(o.db,o.ojstore.name);break;case"closeDB":a.closeDB(o.db)}},100)}(e,t)}};a.openDB(o.name,o.version),t.default=a}]);
//# sourceMappingURL=logServer.js.map
//# sourceMappingURL=logServer.js.map